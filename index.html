<!DOCTYPE html>
<!-- Force new deployment -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFS Bid Submission Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3f51b5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="overlay" class="hidden"><div class="loader"></div></div>
    <div class="container mx-auto max-w-4xl p-4 sm:p-8">
        <div class="text-center mb-8">
            <img src="https://i.ibb.co/qMWCT1wk/logo-on-white.jpg" alt="Company Logo" class="mx-auto h-20 w-auto rounded-full mb-4">
            <h1 class="text-3xl font-bold text-gray-900">Fire Sprinkler Submission</h1>
        </div>
        <form id="submissionForm" class="bg-white p-8 rounded-lg shadow-lg space-y-6">
            <div>
                <label for="submitter" class="block text-sm font-medium text-gray-700">Submitter</label>
                <select id="submitter" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="" disabled selected>Loading...</option></select>
            </div>
            <div>
                <label for="jobType" class="block text-sm font-medium text-gray-700">Job Type</label>
                <select id="jobType" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="New construction">New construction</option>
                    <option value="Retro fit">Retro fit</option>
                    <option value="Service call">Service call</option>
                </select>
            </div>
            <fieldset class="border p-4 rounded-md">
                <legend class="text-lg font-medium text-gray-900 px-2">Job Address</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="md:col-span-2">
                        <label for="streetAddress" class="block text-sm font-medium text-gray-700">Street Address</label>
                        <input type="text" id="streetAddress" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City/Location</label>
                        <input type="text" id="city" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                        <select id="state" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="New York">New York</option>
                            <option value="New Jersey">New Jersey</option>
                        </select>
                    </div>
                </div>
            </fieldset>
            <div class="flex items-start">
                <div class="flex items-center h-5"><input id="isRevisionCheck" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"></div>
                <div class="ml-3 text-sm">
                    <label for="isRevisionCheck" class="font-medium text-gray-700">Is this a revision?</label>
                    <div id="revisionNumberContainer" class="mt-2 hidden">
                        <label for="revisionNumber" class="block text-sm font-medium text-gray-700">Revision Number</label>
                        <input type="text" id="revisionNumber" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>
            <div>
                <label for="companySelect" class="block text-sm font-medium text-gray-700">Company Name</label>
                <select id="companySelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="" disabled selected>Loading...</option></select>
                <input type="text" id="companyNameInput" placeholder="Or type new company name" class="mt-2 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <fieldset id="contactSection" class="border p-4 rounded-md">
                <legend class="text-lg font-medium text-gray-900 px-2">Contacts</legend>
                <div id="contactContainer" class="space-y-6 mt-4"></div>
                <button type="button" id="addContactBtn" class="mt-4 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700"> + Add another contact</button>
            </fieldset>
            <div>
                <label for="comments" class="block text-sm font-medium text-gray-700">Comments</label>
                <textarea id="comments" rows="4" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>
            <div>
                <label for="fileUpload" class="block text-sm font-medium text-gray-700">Upload Plans</label>
                <input type="file" id="fileUpload" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
            </div>
            <button type="submit" id="submitBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Submit</button>
            <p id="msg" class="text-center font-medium mt-4"></p>
        </form>
    </div>
    <template id="contactTemplate">
        <div class="contact-entry p-4 border border-gray-200 rounded-md space-y-4 relative">
            <button type="button" class="remove-contact-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 font-bold text-xl">&times;</button>
            <div>
                <label class="block text-sm font-medium text-gray-700">Contact Name</label>
                <select class="contact-name-select mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm"><option value="">-- Select Existing --</option></select>
                <input type="text" class="contact-name-new mt-2 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" placeholder="Or type new contact name">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Job Title</label>
                <select class="job-title-select mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm"><option value="">-- Select Title --</option></select>
                <input type="text" class="job-title-new mt-2 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm" placeholder="Or type new job title">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Phone(s)</label>
                <div class="phone-container space-y-2 mt-1"></div>
                <button type="button" class="add-sub-button add-phone-btn mt-2 py-1 px-3 border border-transparent rounded-md text-xs font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200">+ Add phone</button>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Email(s)</label>
                <div class="email-container space-y-2 mt-1"></div>
                <button type="button" class="add-sub-button add-email-btn mt-2 py-1 px-3 border border-transparent rounded-md text-xs font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200">+ Add email</button>
            </div>
        </div>
    </template>
    <script>
        // âœ… PASTE YOUR WEB APP URL HERE
        const APPS_SCRIPT_URL = 'YOUR_WEB_APP_URL_HERE';

        let companyData = {}, jobTitles = [], submitters = [];

        document.addEventListener("DOMContentLoaded", () => {
            setLoadingState(true);
            fetch(`${APPS_SCRIPT_URL}?action=getInitialData`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        companyData = result.data.companies || {};
                        jobTitles = result.data.jobTitles || [];
                        submitters = result.data.submitters || [];
                        populateSubmitters(submitters);
                        populateCompanies(companyData);
                        addContact();
                    } else { throw new Error(result.message); }
                })
                .catch(showError)
                .finally(() => setLoadingState(false));

            document.getElementById('submissionForm').addEventListener('submit', handleSubmit);
            document.getElementById('isRevisionCheck').addEventListener('change', toggleRevisionNumber);
            document.getElementById('companySelect').addEventListener('change', handleCompanyChange);
            document.getElementById('addContactBtn').addEventListener('click', () => addContact());
        });

        function populateSubmitters(list) {
            const select = document.getElementById('submitter');
            select.innerHTML = '<option value="" disabled selected>-- Select Submitter --</option>';
            list.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub.email;
                opt.textContent = sub.name;
                select.appendChild(opt);
            });
        }

        function populateCompanies(data) {
            const select = document.getElementById('companySelect');
            select.innerHTML = '<option value="">-- Select Existing Company --</option>';
            Object.keys(data).sort().forEach(company => {
                const opt = document.createElement('option');
                opt.value = company;
                opt.textContent = company;
                select.appendChild(opt);
            });
        }

        function addContact() {
            const template = document.getElementById('contactTemplate');
            const clone = template.content.cloneNode(true);
            const contactEntry = clone.querySelector('.contact-entry');
            const titleSelect = contactEntry.querySelector('.job-title-select');
            jobTitles.forEach(title => {
                const opt = document.createElement('option');
                opt.value = title;
                opt.textContent = title;
                titleSelect.appendChild(opt);
            });
            contactEntry.querySelector('.remove-contact-btn').addEventListener('click', () => contactEntry.remove());
            contactEntry.querySelector('.contact-name-select').addEventListener('change', (e) => populateContactFields(e.target));
            contactEntry.querySelector('.add-phone-btn').addEventListener('click', (e) => addSubInput(e.target, 'tel'));
            contactEntry.querySelector('.add-email-btn').addEventListener('click', (e) => addSubInput(e.target, 'email'));
            addSubInput(contactEntry.querySelector('.add-phone-btn'), 'tel');
            addSubInput(contactEntry.querySelector('.add-email-btn'), 'email');
            document.getElementById('contactContainer').appendChild(clone);
        }

        function addSubInput(button, type, value = '') {
            const container = button.previousElementSibling;
            const input = document.createElement('input');
            input.type = type;
            input.className = "block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm";
            if (type === 'tel') input.placeholder = 'Phone';
            if (type === 'email') input.placeholder = 'Email';
            input.value = value;
            container.appendChild(input);
        }

        function handleCompanyChange() {
            const container = document.getElementById('contactContainer');
            container.innerHTML = '';
            addContact();
            const companyName = document.getElementById('companySelect').value;
            const contactsForCompany = companyData[companyName] || [];
            const contactSelect = container.querySelector('.contact-name-select');
            contactsForCompany.forEach(contact => {
                const opt = document.createElement('option');
                opt.value = contact.name;
                opt.textContent = contact.name;
                contactSelect.appendChild(opt);
            });
        }

        function populateContactFields(selectElement) {
            const contactName = selectElement.value;
            const companyName = document.getElementById('companySelect').value;
            const contactEntry = selectElement.closest('.contact-entry');
            const contact = companyData[companyName]?.find(c => c.name === contactName);
            if (!contact) return;
            const titleSelect = contactEntry.querySelector('.job-title-select');
            const titleInput = contactEntry.querySelector('.job-title-new');
            if (jobTitles.includes(contact.title)) {
                titleSelect.value = contact.title;
                titleInput.value = '';
            } else {
                titleSelect.value = '';
                titleInput.value = contact.title || '';
            }
            const phoneContainer = contactEntry.querySelector('.phone-container');
            phoneContainer.innerHTML = '';
            const phones = contact.phone ? contact.phone.split(',').map(p => p.trim()) : [];
            if (phones.length > 0) phones.forEach(p => addSubInput(contactEntry.querySelector('.add-phone-btn'), 'tel', p));
            else addSubInput(contactEntry.querySelector('.add-phone-btn'), 'tel');
            const emailContainer = contactEntry.querySelector('.email-container');
            emailContainer.innerHTML = '';
            const emails = contact.email ? contact.email.split(',').map(e => e.trim()) : [];
            if (emails.length > 0) emails.forEach(e => addSubInput(contactEntry.querySelector('.add-email-btn'), 'email', e));
            else addSubInput(contactEntry.querySelector('.add-email-btn'), 'email');
        }

        function toggleRevisionNumber() {
            const checkbox = document.getElementById('isRevisionCheck');
            const container = document.getElementById('revisionNumberContainer');
            const input = document.getElementById('revisionNumber');
            container.classList.toggle('hidden', !checkbox.checked);
            input.required = checkbox.checked;
        }

        function handleSubmit(event) {
            event.preventDefault();
            if (!document.getElementById('submissionForm').checkValidity()) {
                showMessage('Please fill out all required fields.', 'error');
                return;
            }
            setLoadingState(true);
            const fileInput = document.getElementById('fileUpload');
            const filePromises = Array.from(fileInput.files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ name: file.name, mimeType: file.type, content: e.target.result.split(',')[1] });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });
            Promise.all(filePromises).then(files => {
                const formData = buildFormData(files);
                if (!formData.companyName) {
                    showError("Please select or enter a company name.");
                    return;
                }
                if (formData.contacts.length === 0) {
                    showError("Please add at least one contact.");
                    return;
                }
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for Apps Script web apps
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    // no-cors mode means we can't read the response, but we assume it's ok
                    showSuccess("Submission sent successfully! You will receive an email shortly.");
                })
                .catch(showError);
            }).catch(showError);
        }

        function buildFormData(files) {
            const submitterSelect = document.getElementById('submitter');
            const companySelect = document.getElementById('companySelect');
            const companyNameInput = document.getElementById('companyNameInput');
            const contactBlocks = document.querySelectorAll('.contact-entry');
            const contacts = Array.from(contactBlocks).map(block => {
                return {
                    name: block.querySelector('.contact-name-new').value.trim() || block.querySelector('.contact-name-select').value,
                    title: block.querySelector('.job-title-new').value.trim() || block.querySelector('.job-title-select').value,
                    phones: Array.from(block.querySelectorAll('.phone-container input')).map(i => i.value.trim()).filter(Boolean),
                    emails: Array.from(block.querySelectorAll('.email-container input')).map(i => i.value.trim()).filter(Boolean)
                };
            }).filter(c => c.name);
            return {
                submitterEmail: submitterSelect.value,
                submitterName: submitterSelect.options[submitterSelect.selectedIndex].text,
                jobType: document.getElementById('jobType').value,
                streetAddress: document.getElementById('streetAddress').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim(),
                isRevision: document.getElementById('isRevisionCheck').checked,
                revisionNumber: document.getElementById('revisionNumber').value.trim(),
                companyName: companyNameInput.value.trim() || companySelect.value,
                comments: document.getElementById('comments').value.trim(),
                contacts: contacts,
                files: files
            };
        }

        function setLoadingState(isLoading) {
            document.getElementById('overlay').classList.toggle('hidden', !isLoading);
            document.getElementById('submitBtn').disabled = isLoading;
        }

        function showMessage(msg, type) {
            const msgElem = document.getElementById('msg');
            msgElem.textContent = msg;
            msgElem.className = `text-center font-medium mt-4 p-2 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
        }

        function showSuccess(message) {
            setLoadingState(false);
            showMessage(message, 'success');
            document.getElementById('submissionForm').reset();
            handleCompanyChange();
            toggleRevisionNumber();
        }

        function showError(error) {
            setLoadingState(false);
            const errorMessage = error && error.message ? error.message : "An unknown network error occurred.";
            showMessage('Error: ' + errorMessage, 'error');
            console.error("An error occurred:", error);
        }
    </script>
</body>
</html>
